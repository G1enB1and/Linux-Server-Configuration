AWL Lightsail Udacity-Ubuntu-512MB-Virginia-1
networking - static IP - bind to above instance as
Udacity-static-IP: 23.20.77.227
private key made by lightsail: LightsailDefaultKey-us-east-1.pem
saved to C:\Users\gbland\.ssh\LightsailDefaultKey-us-east-1.pem

ssh -i .ssh/grader grader@23.20.77.227 -p 2200
grad3r

$ ssh ubuntu@23.20.77.227 -i .ssh/LightsailDefaultKey-us-east-1.pem
$ sudo apt-get update
$ sudo apt-get upgrade
$ sudo apt-get autoremove
$ sudo apt-get install finger
$ sudo adduser --home /home/grader --shell /bin/bash --ingroup admin grader
password: grader

exit - try to log in as grader:

$ ssh grader@23.20.77.227
output: grader@23.20.77.227: Permission denied (publickey).

log back in as ubuntu
$ ssh ubuntu@23.20.77.227 -i .ssh/LightsailDefaultKey-us-east-1.pem

switch to grader
$ su grader

$ sudo whoami
root

exit - try to log in as grader with same key as ubuntu:
$ ssh grader@23.20.77.227 -i .ssh/LightsailDefaultKey-us-east-1.pem
output: grader@23.20.77.227: Permission denied (publickey).

log back in as ubuntu
$ ssh ubuntu@23.20.77.227 -i .ssh/LightsailDefaultKey-us-east-1.pem

check sshd_config for PubkeyAuthentication yes
$ sudo nano /etc/ssh/sshd_config
"PubkeyAuthentication yes" was already set and uncommented.
ctrl x (to exit nano)

switch to the root user
$ sudo su
add a password for that user
$ passwd <username>


to enable sudo for user method 1:
now add the user to sudoers list by running
$ visudo
search for "root ALL = (ALL) ALL"
added "grader ALL = (ALL) ALL" just below it.
write and quit


to enable sudo for user method 2:
$ sudo touch /etc/sudoers.d/grader
$ sudo nano /etc/sudoers.d/grader
add the following line:
"student ALL=(ALL) ALL"
write and quit

switch to new user:
$ su grader

switch to the users home directory:
$ cd /home/grader/

generate keys:
$ ssh-keygen -b4096 -f grader -t rsa
password: grad3r

make a .ssh folder inside the user folder:
$ mkdir .ssh

set permission for owner of file to read, write, and execute:
$ chmod 700 .ssh

store public key in authorized keys file:
$ cat grader.pub > .ssh/authorized_keys

set permission for owner to read and write to the file:
$ chmod 600 .ssh/authorized_keys

set the owner to grader and the group to admin:
$ sudo chown grader:admin .ssh

to set the owner to grader and the group to admin:
$ sudo chown grader:admin .ssh/authorized_keys

to copy user:
sudo rsync -avr grader /home/ubuntu/

set permissions:
$ sudo chmod 777 /home/ubuntu/grader

-- Using your local terminal --

to copy the key "<username>" from your AWS Server:
scp -i .ssh/LightsailDefaultKey-us-east-1.pem ubuntu@23.20.77.227:/home/ubuntu/grader .ssh/grader

set permissions so than owner can read
$ chmod 400 .ssh/grader

to access aws server as this user:
$ ssh -i .ssh/grader grader@23.20.77.227
password: grad3r

-LOGIN SUCCESSFUL!

test sudo:
$ sudo su
[sudo] password for grader:
grader

-success!

Forcing Key Based Authentication: (this was already set)

edit sshd_config: 
$ sudo nano /etc/ssh/sshd_config
change "PasswordAuthentication yes" to no.
write file and exit.
restart to ssh service:
$ sudo service ssh restart

Remove password from grader: (this could have been done earlier when adding grader)
$ sudo nano /etc/sudoers.d/grader
change the following line from
"grader ALL=(ALL) ALL" to "grader ALL=(ALL) NOPASSWD:ALL"
write file and exit
login as root:
$ sudo su
edit visudo:
$ visudo
change the following line from
"grader ALL=(ALL) ALL" to "grader ALL=(ALL) NOPASSWD:ALL"
write file and exit
exit root:
$ exit

-------------------------------------------------------------
Change SSH port 22 to custom port 2200:
add custom TCP port 2200 in AWS Lightsail Networking settings for 23.20.77.227

Configure the Uncomplicated Firewall (UFW) as follows:
only allow incoming connections for SSH port 2200, HTTP port 80, and NTP port 123. (see steps below).
make sure ufw is inactive before configuring it:
$ sudo ufw status
output: status: inactive
set default to deny all incoming
$ sudo ufw default deny incoming
set default to allow all outgoing
$ sudo ufw default allow outgoing
allow ssh:
$ sudo ufw allow ssh
allow ssh on port 2200:
$ sudo ufw allow 2200/tcp
allow www
$ sudo ufw allow www
enable ufw
$ sudo ufw enable
check status
$ sudo ufw status

$ ssh -i .ssh/grader grader@23.20.77.227 -p 2200

output: ssh: connect to host 23.20.77.227 port 2200: Connection refused

$ ssh -i .ssh/grader grader@23.20.77.227

success

Edit sshd_config

$ sudo nano /etc/ssh/sshd_config
added Port 2200 below Port 22
write file and exit
reboot server

$ ssh -i .ssh/grader grader@23.20.77.227 -p 2200
success!

Edit sshd_config

$ sudo nano /etc/ssh/sshd_config
Remove Port 22
write file and exit

Remove SSH Port 22 from AWS Lightsail Networking settings.
Reboot server

$ sudo ufw allow ntp
$ sudo ufw deny 22

$ ssh -i .ssh/grader grader@23.20.77.227 -p 2200
Success!

-----------------------------------------------------
Install Apache
$ sudo apt-get install apache2

Now going to 23.20.77.227 in a browser shows the Apache2 landing page.

Apache, by default, serves its files from the /var/www/html directory. If you explore this directory you will find a file called index.html

------------------------------------------------------
Install mod_wsgi to serve Python 2.7

$ sudo apt-get install libapache2-mod-wsgi

Excerpt from Udacity: "
You then need to configure Apache to handle requests using the WSGI module. You’ll do this by editing the /etc/apache2/sites-enabled/000-default.conf file. This file tells Apache how to respond to requests, where to find the files for a particular site and much more. You can read up on everything this file can do within the Apache documentation.

For now, add the following line at the end of the <VirtualHost *:80> block, right before the closing </VirtualHost> line: WSGIScriptAlias / /var/www/html/myapp.wsgi

Finally, restart Apache with the sudo apache2ctl restart command.

You might get a warning saying "Could not reliably determine the server's fully qualified domain name". If you do, don't worry about it. Check out this AskUbuntu thread for a discussion of the cause of this message."

$ sudo nano /etc/apache2/sites-enabled/000-default.conf
add "WSGIScriptAlias / /var/www/html/myapp.wsgi" just before "</VirtualHost>".
write file and exit (ctrl o, enter, ctrl x)
$ sudo apache2ctl restart

Excerpt from Udacity: "WSGI is a specification that describes how a web server communicates with web applications. Most if not all Python web frameworks are WSGI compliant, including Flask and Django; but to quickly test if you have your Apache configuration correct you’ll write a very basic WSGI application.

You just defined the name of the file you need to write within your Apache configuration by using the WSGIScriptAlias directive. Despite having the extension .wsgi, these are just Python applications. Create the /var/www/html/myapp.wsgi file using the command sudo nano /var/www/html/myapp.wsgi. Within this file, write the following application:"

$ sudo nano /var/www/html/myapp.wsgi
Paste in the following:
"def application(environ, start_response):
    status = '200 OK'
    output = 'Hello Udacity!'

    response_headers = [('Content-type', 'text/plain'), ('Content-Length', str(len(output)))]
    start_response(status, response_headers)

    return [output]"
write file and exit (ctrl o, enter, crtl x)

Excerpt from Udacity: "This application will simply print return Hello Udacity! along with the required HTTP response headers. After saving this file you can reload http://localhost:8080 to see your application run in all its glory!"

Now going to 23.20.77.227 in a browser shows "Hellow Udacity!"

------------------------------------------------------
Install PostgreSQL

$ sudo apt-get install postgresql


-do not allow remote connections.
-create a new database user named "catalog" that has limited permissions 
 to the catalog application database.

------------------------------------------------------
Install git

$ sudo apt-get install git
Configure git for first time use:
$ git config --global user.name "G1enB1and"
$ git config --global user.email "glen.bland.81@gmail.com"
$ git config --global color.ui auto
$ git config --global merge.conflictstyle diff3
$ git config --list

##Git & Code Editor  
The last step of configuration is to get Git working with your code editor.
Below are three of the most popular code editors. If you use a different editor,
then do a quick search on Google for "associate X text editor with Git"
(replace the X with the name of your code editor).  

### Atom Editor Setup  
`git config --global core.editor "atom --wait"`  

### VSCode Setup  
`git config --global core.editor "code --wait"`  

### nano ?
$ git config --global core.editor "nano --wait" ?

nothing done for setting an editor yet. Going to see what happens without setting first.

----------------------------------------------------------------

## To clone an existing git repository:  
`git clone` downloads a copy of an existing repository to the current working directory.  
Current working directory must not already be a git repository.  

Pass the url to an existing git repository by putting the url after `git clone`  
like this: `git clone https://github.com/udacity/course-git-blog-project`  

optionally, you can pass a new repository name after the url to clone an  
existing repository to a new name. Like this:  
`git clone https://github.com/udacity/course-git-blog-project new-repo-name`  

Don't forget to `cd` into the newly cloned directory before attempting any  
other git commands on it.  

$ sudo mkdir /home/ubuntu/gitrepo
$ cd /home/ubuntu/gitrepo
$ sudo git clone https://github.com/G1enB1and/fullstack-nanodegree-vm catalog
$ cd catalog
$ cd vargrant

$ cd /var/www/html
$ sudo mv index.html apache2index.html
$ sudo mv myapp.wsgi helloworld.wsgi
$ sudo mv /home/ubuntu/gitrepo/catalog/vagrant/catalog /var/www/html

---------------------------------------------------------

$ sudo nano /etc/apache2/sites-enabled/000-default.conf
edit "WSGIScriptAlias / /var/www/html/myapp.wsgi" to
"WSGIScriptAlias / /var/www/html/catalog/application.wsgi".
write file and exit (ctrl o, enter, ctrl x)
$ sudo mv application.py catalog.py
$ sudo apache2ctl restart
$ sudo touch /var/www/html/catalog/application.wsgi
$ sudo nano /var/www/html/catalog/application.wsgi

import sys
import logging
logging.basicConfig(stream=sys.stderr)
sys.path.insert(0,"/var/www/html/catalog/")
from catalog import app as application
application.run()

write file and exit (ctrl o, enter, ctrl x)

$ cd /etc/apache2/conf-enabled/
$ sudo touch catalog.conf
$ sudo nano catalog.conf

<VirtualHost *:80>
                ServerName 23.20.77.227
                ServerAdmin glen@glenbland.com
                WSGIDaemonProcess catalog
                WSGIScriptAlias / /var/www/html/catalog/application.wsgi
                <Directory /var/www/html/catalog/>
                        Order allow,deny
                        Allow from all
                </Directory>
                ErrorLog /var/www/html/catalog/FlaskApp-error.log
                LogLevel warn
                CustomLog ${APACHE_LOG_DIR}/FlaskApp-access.log combined
</VirtualHost>

write file and exit (ctrl o, enter, ctrl x)

$ sudo nano /etc/apache2/apache2.conf
add the following line if it's not already there: (in my case it was already there)
IncludeOptional conf-enabled/*.conf

write file and exit (ctrl o, enter, ctrl x)

$ sudo service apache2 restart

---------------------------------------------------------

$ cd /var/www/html/catalog/
$ sudo apt install python-pip
$ pip install Flask

To check installation:
$ pip freeze|grep -i flask
output: Flask==1.0.2

---------------------------------------------------------
Test application:
$ python application.wsgi
ImportError: No module named sqlalchemy

$ pip install sqlalchemy

Test application:
$ python application.wsgi
ImportError: No module named oauth2client.client

$ pip install oath2client

Test application:
$ python application.wsgi
ImportError: No module named requests

$ pip install requests

-----------------------------------------------------------

Test application:
$ python application.wsgi
 
application running...

browsing to 23.20.77.227 and 23.20.77.227:8000 both give error:

Internal Server Error
The server encountered an internal error or misconfiguration and was unable to complete your request.

Please contact the server administrator at glen@glenbland.com to inform them of the time this error occurred, and the actions you performed just before this error.

More information about this error may be available in the server error log.

Apache/2.4.18 (Ubuntu) Server at 23.20.77.227 Port 80

-------------------------------------------------------------

https://stackoverflow.com/questions/42050982/flask-wsgi-no-module-named-flask
says to 
Edit /etc/apache2/sites-available/FlaskApp.conf
(I only have 000-default.conf here, I used conf-enabled instead of sites-enabled. I also named it catalog.conf instead of FlaskApp.conf.

Add the following two lines before the "WSGIScriptAlias" line:

WSGIDaemonProcess FlaskApp python-path=/var/www/FlaskApp:/var/www/FlaskApp/venv/lib/python2.7/site-packages
WSGIProcessGroup FlaskApp

or

WSGIDaemonProcess FlaskApp python-home=/var/www/FlaskApp/venv/FlaskApp WSGIProcessGroup FlaskApp

Restart Apache with "service apache2 restart"

https://www.digitalocean.com/community/tutorials/how-to-run-django-with-mod_wsgi-and-apache-with-a-virtualenv-python-environment-on-a-debian-vps





https://www.youtube.com/watch?v=x6SvecADw2M
http://fosshelp.blogspot.com/2014/03/how-to-deploy-flask-application-with.html

----------------------------------------------------------
$ sudo mv /var/www/html/catalog /var/www/FlaskApp
$ sudo nano application.wsgi
change to:

import os
import sys
import logging
logging.basicConfig(stream=sys.stderr)
sys.path.insert(0,"/var/www/FlaskApp/")
from catalog import app as application
application.run()

$ sudo nano /etc/apache2/conf-enabled/catalog.conf

<VirtualHost *:80>
                ServerName 23.20.77.227
                ServerAdmin glen@glenbland.com
                WSGIDaemonProcess catalog
                WSGIScriptAlias / /var/www/FlaskApp/application.wsgi
                <Directory /var/www/FlaskApp/>
                        Order allow,deny
                        Allow from all
                </Directory>
                ErrorLog /var/www/FlaskApp/FlaskApp-error.log
                LogLevel warn
                CustomLog ${APACHE_LOG_DIR}/FlaskApp-access.log combined
</VirtualHost>
$ cd /etc/apache2/sites-enabled/
$ sudo touch catalog.conf
$ sudo nano catalog.conf

<VirtualHost *:80>
                ServerName 23.20.77.227
                ServerAdmin glen@glenbland.com
                WSGIDaemonProcess catalog
                WSGIScriptAlias / /var/www/FlaskApp/application.wsgi
                <Directory /var/www/FlaskApp/>
                        Order allow,deny
                        Allow from all
                </Directory>
                ErrorLog /var/www/FlaskApp/FlaskApp-error.log
                LogLevel warn
                CustomLog ${APACHE_LOG_DIR}/FlaskApp-access.log combined
</VirtualHost>

$ sudo nano /etc/apache2/sites-enabled/000-default.conf
changed
WSGIScriptAlias / /var/www/FlaskApp/application.wsgi

-------------------------------------------------------------
Setup venv virtual environment:

$ cd /var/www/FlaskApp

$ sudo pip install virtualenv
$ sudo virtualenv venv
venv can be replaced with any name
$ source venv/bin/activate
$ sudo pip install Flask

--------------------------------------------------------------

##Virtualenv Settings ??? - not added yet. don't understand

activate_this = '/var/www/FlaskApp/venv/bin/activate_this.py'
execfile(activate_this, dict(__file__=activate_this))


$ sudo nano application.wsgi
change to:

import os
import sys
import logging

logging.basicConfig(stream=sys.stderr)

activate_this = '/var/www/FlaskApp/venv/bin/activate_this.py'
execfile(activate_this, dict(__file__=activate_this))

sys.path.insert(0,"/var/www/FlaskApp/")

from catalog import app as application
application.run()

----------------------------------------------------------
$ sudo nano catalog.conf (in sites-enabled and conf-enabled)

<VirtualHost *:80>
                ServerName 23.20.77.227
                ServerAdmin glen@glenbland.com
                WSGIDaemonProcess FlaskApp python-path=/var/www/FlaskApp:/var/www/FlaskApp/venv/lib/python2.7/site-packages
                WSGIProcessGroup FlaskApp
                WSGIScriptAlias / /var/www/FlaskApp/application.wsgi
                WSGIScriptReloading On
                <Directory /var/www/FlaskApp/>
                        Order allow,deny
                        Allow from all
                </Directory>
                ErrorLog /var/www/FlaskApp/FlaskApp-error.log
                LogLevel warn
                CustomLog ${APACHE_LOG_DIR}/FlaskApp-access.log combined
</VirtualHost>

-------------------------------------------------------------

root@ip-172-26-6-126:/etc/apache2/conf-enabled# service apache2 restart
Job for apache2.service failed because the control process exited with error cod
e. See "systemctl status apache2.service" and "journalctl -xe" for details.


duplicate wsgi designation in catalog.conf.

removed the copy in conf-enabled and kept the one in sites-enabled.
This fixed the issue and allows apche2 service to restart.

----------------------------------------------------------------

now I am still getting internal server error

$ sudo mv sites-enabled/catalog.conf sites-available/catalog.conf

Enable site
$ sudo a2ensite catalog
Restart server
$ sudo systemctl restart apache2
$ sudo apache2ctl restart

set permissions
sudo chmod -R 755 /var/www

changed catalog.py file to run on port 8000 as it was before I changed it to 80 earlier.

$ sudo ufw allow 8000

added custom tcp port 8000 in aws
rebooted.

$ sudo a2dissite 000-default 
$ sudo systemctl restart apache2

-----------------------------------------------------

$ ls -las /etc/apache2/sites-available/
total 24
4 drwxr-xr-x 2 root root 4096 Dec 26 15:18 .
4 drwxr-xr-x 8 root root 4096 Dec 14 15:55 ..
4 -rw-r--r-- 1 root root 1392 Dec 14 15:59 000-default.conf
4 -rw-r--r-- 1 root root  716 Dec 14 18:13 catalog.conf
8 -rw-r--r-- 1 root root 6338 Jun 11  2018 default-ssl.conf

$ ls -las /etc/apache2/sites-enabled/
total 8
4 drwxr-xr-x 2 root root 4096 Dec 26 15:57 .
4 drwxr-xr-x 8 root root 4096 Dec 14 15:55 ..
0 lrwxrwxrwx 1 root root   31 Dec 26 15:19 catalog.conf -> ../sites-available/catalog.conf


WSGIDaemonProcess FlaskApp python-path=/var/www/FlaskApp:/var/w$/var/www/FlaskApp/venv/lib/python2.7/site-packages

-----------------------------------------------------------------

moved files from FlaskApp to FlaskApp/venv
updated catalog.conf to point to FlaskApp/venv
$ sudo python catalog.py

--------------------  It works!!!!!  ----------------------------

final catalog.conf in /etc/apache2/sites-available/ is as follows:

<VirtualHost *:80>
                ServerName 23.20.77.227
                ServerAdmin glen@glenbland.com
                WSGIDaemonProcess FlaskApp python-path=/var/www/FlaskApp/venv:/var/www/FlaskApp/venv/lib/python2.7/site-packages
                WSGIProcessGroup FlaskApp
                WSGIScriptAlias / /var/www/FlaskApp/venv/application.wsgi
                WSGIScriptReloading On
                <Directory /var/www/FlaskApp/venv>
                        Order allow,deny
                        Allow from all
                </Directory>
                ErrorLog /var/www/FlaskApp/venv/FlaskApp-error.log
                LogLevel warn
                CustomLog ${APACHE_LOG_DIR}/FlaskApp-access.log combined
</VirtualHost>


------------------------------------------------------------------
Google Login link does not work:
400. That’s an error.

Error: invalid_request

Permission denied to generate login hint for target domain.

Request Details
response_type=permission id_token code
scope=openid email
openid.realm=
prompt=consent
access_type=offline
include_granted_scopes=true
redirect_uri=storagerelay://http/23.20.77.227:8000?id=auth231985
client_id=595888207696-saiiv3l4m0obuhj79al9liojp2r5eea9.apps.googleusercontent.com
ss_domain=http://23.20.77.227:8000
gsiwebsdk=shim


---------------------------------------------------------------
changed catalog.conf

<VirtualHost *:80>
                ProxyPreserveHost On
                ProxyRequests Off
                ServerName www.catalog.glenbland.com
                ServerAlias catalog.glenbland.com
                ProxyPass / http://23.20.77.227:8000/
                ProxyPassReverse / http://23.20.77.227:8000/
                ServerAdmin glen@glenbland.com
                WSGIDaemonProcess FlaskApp python-path=/var/www/FlaskApp/venv:/var/www/FlaskApp/venv/lib/python2.7/site-packages
                WSGIProcessGroup FlaskApp
                WSGIScriptAlias / /var/www/FlaskApp/venv/application.wsgi
                WSGIScriptReloading On
                <Directory /var/www/FlaskApp/venv>
                        Order allow,deny
                        Allow from all
                </Directory>
                ErrorLog /var/www/FlaskApp/venv/FlaskApp-error.log
                LogLevel warn
                CustomLog ${APACHE_LOG_DIR}/FlaskApp-access.log combined
</VirtualHost>


$ sudo a2enmod proxy && sudo
 a2enmod proxy_http && sudo service apache2 restart

Enabling module proxy.
To activate the new configuration, you need to run:
  service apache2 restart
Considering dependency proxy for proxy_http:
Module proxy already enabled
Enabling module proxy_http.
To activate the new configuration, you need to run:
  service apache2 restart
grader@ip-172-26-6-126:/etc/apache2/sites-available$

